package com.maxiaohua.genealogy.main.biz.com.impl;

import com.maxiaohua.genealogy.fw.core.biz.AbstractDBLogic;
import com.maxiaohua.genealogy.main.biz.com.GbCustomer;
import com.maxiaohua.genealogy.main.biz.constant.CommonConstant;
import com.maxiaohua.genealogy.main.biz.constant.CtgCodeConstant;
import com.maxiaohua.genealogy.main.biz.constant.HbMessageCode;

public class GbCustomerImpl extends AbstractDBLogic implements GbCustomer, HbMessageCode, CommonConstant, 
		CtgCodeConstant {
	public String regist(String mobile, String validCode, 
			Double longitude, Double latitude, String cityCode, String registrationID,Integer ismi){
		LoginDTO login = new LoginDTO();
		String code = null;
		code = queryKeyValue.queryForString(mobile);
		if(code == null || !code.equals(validCode)){
			createApplicationException(M10640WS);
		}
		
		CustomerInfoDTO customer = new CustomerInfoDTO();
		customer.setMobileNo(mobile);
		if(queryDAO.queryForObject(CustomerInfoDTO.EQUAL_SEARCH, customer) != null){
			createApplicationException(M10050WC);
		}
		
		customer.setMobileNo(mobile);
		customer.setLicencePlate(licencePlate);
		customer.setStatus(Integer.parseInt(LOGIN_STATUS.ONLINE.toString()));
		customer.setLatitude(latitude);
		customer.setLongitude(longitude);
		customer.setRegeditDate(this.getCurrentDate());
		customer.setRegeditTime(this.getCurrentTime());
		updateDAO.updateOne(CustomerInfoDTO.INSERT, customer, M10190WS, SH_INFO);
		
		CarInfoDTO car = new CarInfoDTO();
		car.setCustomerID(customer.getCustomerID());
		car.setLicencePlate(licencePlate);
		updateDAO.updateOne(CarInfoDTO.INSERT, car, M10190WS, SH_INFO);
		
		//更新设备类型
		if(imsi!=null){
			imsi= 1;//defualt iphone
		}
		MobileInfoDTO mobileDto = new MobileInfoDTO();
		mobileDto.setCustomerID(customer.getCustomerID());
//			mobileDto.setIMSI(imsi);
		mobileDto = this.queryDAO.queryForObject(MobileInfoDTO.EQUAL_SEARCH, mobileDto);
		if(mobileDto==null){
			mobileDto = new MobileInfoDTO();
			mobileDto.setCustomerID(customer.getCustomerID());
			mobileDto.setIMSI(imsi);
			this.updateDAO.update(MobileInfoDTO.INSERT, mobileDto);
		}
		else{
			mobileDto.setIMSI(imsi);
			this.updateDAO.update(MobileInfoDTO.UPDATE, mobileDto);
		}
		
		login.setUserID(customer.getCustomerID());
		login.setMobile(customer.getMobileNo());
		login.setLicensePlates(car.getLicencePlate());
		
		hbJPush.updateCustomerJPush(customer.getCustomerID(), registrationID);
		
		return login;
	}
}